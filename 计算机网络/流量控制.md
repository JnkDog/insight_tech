# 流量控制理解
## 为什么要流量控制
**TCP**为应用提供的功能，用来消除发送方使接收方缓存溢出的可能。而**拥塞控制**是IP网络提供的。发送方数据到达后，相关应用可能不会立马读取数据，如果应用数据读取缓慢，发送方发的太快造成缓冲区溢出！！！

## 如何流量控制
TCP通过**发送方**维护一个接受窗口来表示**接受方**最多还有多少缓存空间。
如果缓冲区满了，并从接收方告诉发送方以后，即不要再发新数据了。那么等接收方应用数据清空缓存以后，发送方并不会知道接受方已经清空缓存了。（TCP仅当它有确认要发送或有数据才会发送ACK）

* 所以问题就出现了，发送方如何知道接送方已经清空缓冲区，然后再继续发送呢？
TCP规定：当接收方的窗口大小为0时，发送方会继续发送一个字节的报文段。这些报文段会被接收方确认，然后缓存清空后，ACK报文会返回一个非0的窗口大小。

UDP不提供流量控制，最后可能会造成缓存溢出！

## 小实验
1. 下载一个2G文件，客户端直接curl
```shell
# 什么都不动大概花费20s
curl http://192.168.56.2:8080/test.log --output ./test.log
```
100MB/s ---> 20s

2GB x 1024 / 20 = 100 MB/s

rtt = 0.8ms  ---> ping测试结果
bandwidth = 1.10Gb/s  ---> iperf3 
1.10/8 = 0.125 GB/s x 1024 = 100MB/s

BDF
100 x 0.0008s / 8 = 0.01 Mb = 10 Kb

2. 添加对应的tc规则 100ms
```shell
# Server
tc qdisc show dev enp0s3
tc qdisc del dev enp0s3 root
tc qdisc add dev enp0s3 root netem delay 100ms

# 花费了1分16秒
```