# 哨兵机制

## 哨兵机制的作用
在主从服务器中，有一个最大的问题。主数据库挂了，那么从数据库如何进行切换。可不可以进行自动的数据库切换。这就带来了哨兵模式。在 Redis 主从集群中，哨兵机制是实现主从库自动切换的关键机制，它有效地解决了主从复制模式下故障转移的这三个问题。
1. 主库真的挂了吗？
2. 该选择哪个从库作为主库？
3. 怎么把新主库的相关信息通知给从库和客户端呢？
即**监控，选主，通知**

开启的哨兵机制其实是一个**进程**  ---> tbc
也就是说在启动redis中，可能会创造2个进程，一个redis数据库 另一个则是哨兵进程。

### 监控的步骤
哨兵在周期运行的时候会周期性发送ping命令给主从库，检测主从库是否正常运行。如果没有在规定时间内响应ping命令，哨兵就会把监控的库标记为下线状态。

#### 下线状态
主观下线和客观下线
主观下线 -- 哨兵进程会使用 PING 命令检测它自己和主、从库的网络连接情况，用来判断实例的状态。如果哨兵发现主库或从库对 PING 命令的响应超时了，那么，哨兵就会先把它标记为“主观下线”。

如果检测的是从库，那么，哨兵简单地把它标记为“主观下线”就行了，因为从库的下线影响一般不太大，集群的对外服务不会间断。

但是，如果检测的是主库，那么，哨兵还不能简单地把它标记为“主观下线”，开启主从切换。因为很有可能存在这么一个情况：那就是哨兵误判了，其实主库并没有故障。可是，一旦启动了主从切换，后续的选主和通知操作都会带来额外的计算和通信开销。误判下线的成本太高啦。

那么如何判定一个主库是否下线  即客观下线 --> 依赖少数服从大多数的机制。

![](./pictures/%E5%AE%A2%E8%A7%82%E4%B8%8B%E7%BA%BF.png)

3个哨兵，2个判断下线才进行选主

### 主库选举
主库的选举中需要进行初步筛选，过滤掉不合适的备选者。

检查从库的当前在线状态，判断它之前的网络连接状态。如果从库总是和主库断连，而且断连次数超出了一定的阈值，我们就有理由相信，这个从库的网络状况并不是太好，就可以把这个从库筛掉了。

在过滤掉从库备选者后，然后进行三个打分规则挑选主库。这三个规则分别是从库优先级、从库复制进度以及从库 ID 号。只要在某一轮中，有从库得分最高，那么它就是主库了，选主过程到此结束。如果没有出现得分最高的从库，那么就继续进行下一轮。

#### 优先级最高的从库得分高
用户可以通过 slave-priority 配置项，给不同的从库设置不同优先级。比如，你有两个从库，它们的内存大小不一样，你可以手动给内存大的实例设置一个高优先级。在选主时，哨兵会给优先级高的从库打高分，如果有一个从库优先级最高，那么它就是新主库了。如果从库的优先级都一样，那么哨兵开始第二轮打分。

#### 和旧主库同步程度最接近的从库得分高
主从库同步时有个命令传播的过程。在这个过程中，主库会用 master_repl_offset 记录当前的最新写操作在 repl_backlog_buffer 中的位置，而从库会用 slave_repl_offset 这个值记录当前的复制进度。

此时，我们想要找的从库，它的 slave_repl_offset 需要最接近 master_repl_offset。如果在所有从库中，有从库的 slave_repl_offset 最接近 master_repl_offset，那么它的得分就最高，可以作为新主库。

#### ID 号小的从库得分高
每个实例都会有一个 ID，这个 ID 就类似于这里的从库的编号。目前，Redis 在选主库时，有一个默认的规定：在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库。


### 哨兵集群
由于单个哨兵可能会对主库的下线判断有误判的情况。解决思路是设置多个哨兵集群进行判断。那么这样会随之带来问题：

#### 哨兵之间如何互相发现
哨兵之间如何进行沟通和发现 ---> 基于pub/sub的哨兵集群组成（pub/sub的理解 ---> tbc）
在配置哨兵的过程中，需要设置**主库**的ip和端口。

哨兵只要和主库建立起了连接，就可以在主库上发布消息了，比如说发布它自己的连接信息（IP 和端口）。同时，它也可以从主库上订阅消息，获得其他哨兵发布的连接信息。当多个哨兵实例都在主库上做了发布和订阅操作后，它们之间就能知道彼此的 IP 地址和端口。

哨兵不单单需要对主库进行连接，也需要对从库进行连接。因为在进行从库选举过后，需要把新主库的信息传递给其他从库。

#### 哨兵如何发现从库的IP和端口号
哨兵发送**info**给主库，主库就会把从库列表信息发给哨兵。

PS：info指令返回什么？
Info 命令以一种易于理解和阅读的格式，返回关于 Redis 服务器的各种信息和统计数值。里面包含replication的从库信息？ ---> tbc

#### 客户端如何知道主从库进行了切换
从本质上说，哨兵就是一个运行在特定模式下的 Redis 实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。所以，每个哨兵实例也提供 pub/sub 机制，客户端可以从哨兵订阅消息。哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件。


### 哨兵主从切换的执行过程
开头注意 判断下线和选主库是2个不一样的过程，别搞混

#### 判断下线
任何一个实例只要自身判断主库“主观下线”后，就会给其他实例发送 is-master-down-by-addr 命令。接着，其他实例会根据自己和主库的连接情况，做出 Y 或 N 的响应，Y 相当于赞成票，N 相当于反对票。一个哨兵获得了仲裁所需的赞成票数后，就可以标记主库为“客观下线”。这个所需的赞成票数是通过哨兵配置文件中的 **quorum** 配置项设定的。例如，现在有 5 个哨兵，quorum 配置的是 3，那么，一个哨兵需要 3 张赞成票，就可以标记主库为“客观下线”了。这 3 张赞成票包括哨兵自己的一张赞成票和另外两个哨兵的赞成票。

总的来说是 票数 >= quorum ----> 客观下线

#### 执行选主
发现主库下线的哨兵可以进行选主操作。表明希望由自己来执行主从切换，并让所有其他哨兵进行投票。这个投票过程称为“Leader 选举”。**因为最终执行主从切换的哨兵称为 Leader，投票过程就是确定 Leader。**
在投票过程中，任何一个想成为 Leader 的哨兵，要满足两个条件：
* 拿到半数以上的赞成票；比如5个redis，需要3张票成为leader
* 拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。以 3 个哨兵为例，假设此时的 quorum 设置为 2，那么，任何一个想成为 Leader 的哨兵只要拿到 2 张赞成票，就可以了。

如果有2个实例平票的情况下。
哨兵集群会等待一段时间（也就是哨兵故障转移超时时间的 2 倍），再重新选举。大多数情况下，是因为网络的原因造成的。

思考的时候需要注意 分为客观下线判断以及leader选举。别搞混